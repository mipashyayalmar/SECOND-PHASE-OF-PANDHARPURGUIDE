<style>
    .booking-popup {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: linear-gradient(145deg, #ffffff, #f9fbfc);
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
        z-index: 1001;
        max-width: 90%;
        width: 450px;
        font-family: 'Segoe UI', Tahoma, sans-serif;
        animation: fadeIn 0.3s ease-in-out;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translate(-50%, -55%); }
        to { opacity: 1; transform: translate(-50%, -50%); }
    }

    .booking-popup .close-btn {
        position: absolute;
        top: 12px;
        right: 12px;
        cursor: pointer;
        font-size: 1.8rem;
        color: #777;
        background: transparent;
        transition: color 0.3s;
    }

    .booking-popup .close-btn:hover {
        color: #e63946;
    }

    .booking-line {
        color: #2a9d8f;
        font-weight: 600;
        margin: 15px 0;
        display: flex;
        align-items: center;
        flex-wrap: wrap;
    }

    .date-range-connector {
        display: flex;
        align-items: center;
        margin: 5px 0;
        width: 100%;
    }

    .date-range-connector .date-box {
        padding: 8px 12px;
        background-color: #2a9d8f;
        color: white;
        border-radius: 6px;
        margin: 0 8px;
        font-size: 0.95rem;
    }

    .date-range-connector .connect-line {
        flex-grow: 1;
        height: 4px;
        background: linear-gradient(to right, #2a9d8f, #48cae4);
        margin: 0 8px;
    }

    .guest-info {
        margin-top: 15px;
        padding: 15px;
        background-color: #fff;
        border-radius: 8px;
        border: 1px solid #e9ecef;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .guest-info div {
        margin-bottom: 8px;
    }

    .guest-info strong {
        color: #264653;
        font-weight: 600;
        display: inline-block;
        min-width: 120px;
    }

    .btn-success {
        background-color: #2a9d8f;
        border: none;
        padding: 10px 20px;
        border-radius: 6px;
        font-weight: 500;
        color: white;
        transition: background-color 0.2s, transform 0.2s;
    }

    .btn-success:hover {
        background-color: #28786e;
        transform: translateY(-2px);
    }

    .table-responsive {
        border-radius: 8px;
        overflow: hidden;
    }

    .table {
        margin-bottom: 0;
    }

    .table-hover tbody tr:hover {
        background-color: #f1faee;
    }

    .table-light th {
        background-color: #264653;
        color: white;
        font-weight: 600;
        padding: 12px;
    }

    .table td {
        padding: 12px;
        vertical-align: middle;
        color: #495057;
    }

    .text-primary {
        color: #2a9d8f !important;
    }

    .badge {
        padding: 6px 10px;
        font-size: 0.9rem;
    }

    .status-past {
        background-color: #fef2f2;
    }

    .status-current {
        background-color: #f0fdf4;
    }

    .status-future {
        background-color: #eff6ff;
    }

    .date-highlight {
        background-color: #e0f2fe !important;
        font-weight: bold;
    }

    @media (max-width: 768px) {
        .booking-popup {
            width: 90%;
            max-width: 350px;
        }

        .date-range-connector {
            justify-content: center;
        }

        .guest-info strong {
            min-width: 100px;
        }

        .table th, .table td {
            font-size: 0.85rem;
            padding: 8px;
        }
    }

    @media (max-width: 480px) {
        .booking-popup {
            width: 95%;
            padding: 15px;
        }

        .table {
            display: block;
            overflow-x: auto;
        }

        .table th, .table td {
            font-size: 0.8rem;
            padding: 6px;
        }
    }
</style>

<div class="table-responsive">
    <table class="table table-bordered table-hover">
        <thead class="table-light">
            <tr>
                <th scope="col">Booking Id</th>
                <th scope="col">Guest</th>
                <th scope="col">Room</th>
                <th scope="col">Guests</th>
                <th scope="col">Check-in</th>
                <th scope="col">Check-out</th>
                <th scope="col">Nights</th>
                <th scope="col">Hotel</th>
                <th scope="col">Booking Date</th>
                <th scope="col">Status</th>
                <th scope="col">Pricing Details</th>
                <th scope="col">Total (with GST)</th>
                <th scope="col">Actions</th>
            </tr>
        </thead>
        <tbody>
            {% if bookings %}
                {% for booking in bookings %}
                <tr class="status-{{ booking.status }}">
                    <td>{{ booking.id }}</td>
                    <td class="fw-medium">
                        <a href="{% url 'user:user_profile_detail' username=booking.guest.username %}" 
                           class="text-primary text-decoration-none">
                            {{ booking.guest.get_full_name|default:booking.guest.username }}
                        </a>
                    </td>
                    <td>
                        <a href="{% url 'viewroom' booking.room.id %}" class="text-decoration-none">
                            {{ booking.room.room_number }} ({{ booking.room.get_room_type_display }})
                        </a>
                    </td>
                    <td>
                        <div class="guest-details">
                            <div class="d-flex justify-content-between">
                                <span>Total Guests:</span>
                                <strong>{{ booking.guests }}</strong>
                            </div>
                            {% if booking.extra_guests > 0 %}
                            <div class="d-flex justify-content-between text-success">
                                <span>Extra Guests:</span>
                                <strong>+{{ booking.extra_guests }}</strong>
                            </div>
                            <div class="small text-muted">
                                (₹{{ booking.room.extra_capacity_charge }} per extra guest)
                            </div>
                            {% endif %}
                              <div class="small text-muted">
                                {% if booking.room.extra_person_charges %}+ ₹{{ booking.room.extra_person_charges|floatformat:2 }} (per extra guest){% else %}(no extra charges){% endif %}
                            </div>
                            <div class="d-flex justify-content-between small text-info">
                                <span>Room Capacity:</span>
                                <span>{{ booking.room.capacity }} + {{ booking.room.extra_capacity }}</span>
                            </div>
                        </div>
                    </td>
                    <td class="bg-success bg-opacity-10 {% if booking.check_in == current_date %}date-highlight{% endif %}">
                        {{ booking.check_in|date:"M d, Y" }}
                    </td>
                    <td class="bg-warning bg-opacity-10 {% if booking.check_out == current_date %}date-highlight{% endif %}">
                        {{ booking.check_out|date:"M d, Y" }}
                    </td>
                    <td>
                        {{ booking.nights }} night{{ booking.nights|pluralize }}
                    </td>
                    <td>{{ booking.room.hotel.name }}</td>
                    <td class="bg-primary bg-opacity-10">
                        {{ booking.booking_time|date:"M d, Y H:i" }}
                    </td>
                    <td>
                        <span class="badge 
                            {% if booking.status == 'past' %}bg-secondary
                            {% elif booking.status == 'current' %}bg-success
                            {% else %}bg-primary{% endif %}">
                            {{ booking.status|title }}
                        </span>
                    </td>
                    <td class="fw-medium">
                        <div class="pricing-details">
                            <div class="d-flex justify-content-between">
                                <span>Base Price:</span>
                                <span>₹{{ booking.base_price|floatformat:2 }}</span>
                            </div>
                            {% if booking.extra_guests > 0 %}
                            <div class="d-flex justify-content-between text-success">
                                <span>Extra Guests:</span>
                                <span>₹{{ booking.extra_guest_charges|floatformat:2 }}</span>
                            </div>
                            {% endif %}
                            <div class="d-flex justify-content-between small text-muted">
                                <span>GST ({{ booking.gst_rate|floatformat:2 }}%):</span>
                                <span>₹{{ booking.gst_amount|floatformat:2 }}</span>
                            </div>
                        </div>
                    </td>
                    <td class="fw-bold">
                        ₹{{ booking.total_price|floatformat:2 }}
                    </td>
                    <td>
                        <a href="#" class="text-primary text-decoration-none view-booking" 
                           data-booking='{
                               "guest": "{{ booking.guest.get_full_name|default:booking.guest.username|escapejs }}",
                               "room": "{{ booking.room.get_room_type_display|escapejs }} (Room {{ booking.room.room_number|escapejs }})",
                               "hotel": "{{ booking.room.hotel.name|escapejs }}",
                               "check_in": "{{ booking.check_in|date:'M d, Y'|escapejs }}",
                               "check_out": "{{ booking.check_out|date:'M d, Y'|escapejs }}",
                               "nights": "{{ booking.nights|escapejs }}",
                               "guests": "{{ booking.guests|escapejs }}",
                               "extra_guests": "{{ booking.extra_guests|escapejs }}",
                               "extra_guest_charge": "{{ booking.room.extra_capacity_charge|escapejs }}",
                               "base_amount": "{{ booking.base_price|floatformat:2|escapejs }}",
                               "gst_rate": "{{ booking.gst_rate|floatformat:2|escapejs }}",
                               "total_amount": "{{ booking.total_price|floatformat:2|escapejs }}"
                           }'>View</a>
                    </td>
                </tr>
                {% endfor %}
            {% else %}
                <tr>
                    <td colspan="13" class="text-center text-muted py-4">
                        No bookings found matching your criteria.
                    </td>
                </tr>
            {% endif %}
        </tbody>
    </table>
</div>

<style>
    .guest-details div,
    .pricing-details div {
        margin-bottom: 0.2rem;
    }
    .date-highlight {
        font-weight: bold;
        border-left: 3px solid #0d6efd !important;
        border-right: 3px solid #0d6efd !important;
    }
</style>
{% if bookings.has_other_pages %}
<nav class="d-flex justify-content-center mt-4">
    <ul class="pagination">
        {% if bookings.has_previous %}
            <li class="page-item">
                <a class="page-link" 
                   href="?page=1{% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                    « First
                </a>
            </li>
            <li class="page-item">
                <a class="page-link" 
                   href="?page={{ bookings.previous_page_number }}{% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                    Previous
                </a>
            </li>
        {% endif %}
        
        <li class="page-item active">
            <span class="page-link">
                Page {{ bookings.number }} of {{ bookings.paginator.num_pages }}
            </span>
        </li>
        
        {% if bookings.has_next %}
            <li class="page-item">
                <a class="page-link" 
                   href="?page={{ bookings.next_page_number }}{% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                    Next
                </a>
            </li>
            <li class="page-item">
                <a class="page-link" 
                   href="?page={{ bookings.paginator.num_pages }}{% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                    Last »
                </a>
            </li>
        {% endif %}
    </ul>
</nav>
{% endif %}

<script>
    document.addEventListener('DOMContentLoaded', function() {
        function showBookingPopup(bookingData) {
            const existingPopup = document.querySelector('.booking-popup');
            if (existingPopup) existingPopup.remove();

            const checkInDate = bookingData.check_in;
            const checkOutDate = bookingData.check_out;
            const checkInDay = checkInDate.split(',')[0].split(' ')[1];
            const checkOutDay = checkOutDate.split(',')[0].split(' ')[1];
            const checkInMonth = checkInDate.split(',')[0].split(' ')[0];
            const checkOutMonth = checkOutDate.split(',')[0].split(' ')[0];

            // Calculate GST amount
            const baseAmount = parseFloat(bookingData.base_amount);
            const gstRate = parseFloat(bookingData.gst_rate) || 12.00; // Default to 12%
            const gstAmount = baseAmount * (gstRate / 100);
            const totalWithGst = baseAmount + gstAmount;

            const popup = document.createElement('div');
            popup.className = 'booking-popup';
            popup.innerHTML = `
                <span class="close-btn">×</span>
                <h3>Booking Details</h3>
                <div class="booking-line">
                    <div class="date-range-connector">
                        <div class="date-box">${checkInMonth} ${checkInDay}</div>
                        <div class="connect-line"></div>
                        <div class="date-box">${checkOutMonth} ${checkOutDay}</div>
                    </div>
                </div>
                <div class="guest-info">
                    <div><strong>Guest:</strong> ${bookingData.guest}</div>
                    <div><strong>Room:</strong> ${bookingData.room}</div>
                    <div><strong>Hotel:</strong> ${bookingData.hotel}</div>
                    <div><strong>Check-in:</strong> ${checkInDate}</div>
                    <div><strong>Check-out:</strong> ${checkOutDate}</div>
                    <div><strong>Nights:</strong> ${bookingData.nights}</div>
                    <div><strong>Base Amount:</strong> ₹${baseAmount.toFixed(2)} (₹${(baseAmount / bookingData.nights).toFixed(2)} × ${bookingData.nights} nights)</div>
                    <div><strong>GST (${gstRate.toFixed(2)}%):</strong> ₹${gstAmount.toFixed(2)}</div>
                    <div><strong>Total with GST:</strong> ₹${totalWithGst.toFixed(2)}</div>
                </div>
                <div class="text-center mt-3">
                    <button class="btn btn-success">
                        <i class="fas fa-comment-alt mr-2"></i>Connect with us
                    </button>
                </div>
            `;
            document.body.appendChild(popup);

            popup.querySelector('.close-btn').addEventListener('click', () => {
                popup.remove();
            });

            document.addEventListener('click', function outsideClickListener(event) {
                if (!popup.contains(event.target) && !event.target.closest('.view-booking')) {
                    popup.remove();
                    document.removeEventListener('click', outsideClickListener);
                }
            });
        }

        document.querySelectorAll('.view-booking').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const bookingData = JSON.parse(this.getAttribute('data-booking'));
                showBookingPopup(bookingData);
            });
        });
    });
</script>